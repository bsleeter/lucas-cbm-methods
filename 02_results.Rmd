# Results

```{r, warning=F, message=F, echo=F}
library(raster)
library(sf)
library(tidyverse)
library(cowplot)
library(dplyr)

theme_custom <- function(...) {
  theme_bw() +
  theme(
    text = element_text(family="Roboto Condensed"),
    axis.text.x = element_text(size=8),
    axis.text.y = element_text(size=8),
    axis.title.x = element_text(size=8),
    axis.title.y = element_text(size=8),
    plot.margin = margin(3,3,1,3, unit="mm"),
    strip.text = element_text(size=8),
    panel.border = element_rect(fill=NA),
    panel.spacing = unit(2, "mm"),
    panel.grid.minor = element_blank(),
    strip.background = element_blank(),
    legend.text = element_text(size=8),
    legend.title = element_text(size=8),
    ...
  )}

scenario_ids = data.frame(ScenarioID=c(128,134,136,138),
                          ScenarioName = c("LULC+Clim", "Clim", "Ref", "LULC"))

```

```{r, resultdata, echo=F, warning=F, message=F}

flowTypes_net = c("Net Primary Productivity", "Net Ecosystem Productivity", "Net Biome Productivity", "Emission: Total")

flows_net = read_csv("data/results/flows_conus.csv") %>%
  left_join(scenario_ids) %>%
  filter(FlowGroupID %in% flowTypes_net) %>%
  mutate(FlowGroupID = factor(FlowGroupID, levels=c("Net Primary Productivity","Emission: Total","Net Ecosystem Productivity", "Net Biome Productivity")))

flows_net_mmt = flows_net %>% mutate(Amount=round(Amount/1000000,0))

nbp_primary = flows_net_mmt %>% filter(ScenarioName=="LULC+Clim", FlowGroupID=="Net Biome Productivity")
nbp_primary_mean = round(mean(nbp_primary$Amount),0)
nbp_primary_min = min(nbp_primary$Amount)
nbp_primary_max = max(nbp_primary$Amount)

nbp_lulc = flows_net_mmt %>% filter(ScenarioName=="LULC", FlowGroupID=="Net Biome Productivity")
nbp_lulc_mean = round(mean(nbp_lulc$Amount),0)
nbp_lulc_min = min(nbp_lulc$Amount)
nbp_lulc_max = max(nbp_lulc$Amount)

nbp_climate = flows_net_mmt %>% filter(ScenarioName=="Clim", FlowGroupID=="Net Biome Productivity")
nbp_climate_mean = round(mean(nbp_climate$Amount),0)
nbp_climate_min = min(nbp_climate$Amount)
nbp_climate_max = max(nbp_climate$Amount)

npp_primary = flows_net_mmt %>% filter(ScenarioName=="LULC+Clim", FlowGroupID=="Net Primary Productivity")
npp_primary_mean = round(mean(npp_primary$Amount),0)

npp_clim = flows_net_mmt %>% filter(ScenarioName=="Clim", FlowGroupID=="Net Primary Productivity")
npp_clim_mean = round(mean(npp_clim$Amount),0)

npp_lulc = flows_net_mmt %>% filter(ScenarioName=="LULC", FlowGroupID=="Net Primary Productivity")
npp_lulc_mean = round(mean(npp_lulc$Amount),0)

npp_lulc_pct = round((npp_clim_mean-npp_primary_mean)/npp_clim_mean*100,0)
npp_clim_pct = round((npp_lulc_mean-npp_primary_mean)/npp_lulc_mean*100,0)

npp_lulc_abs = round((npp_clim_mean-npp_primary_mean),0)
npp_clim_abs = round((npp_lulc_mean-npp_primary_mean),0)

rh_primary = flows_net_mmt %>% filter(ScenarioName=="LULC+Clim", FlowGroupID=="Emission: Total")
rh_primary_mean = round(mean(rh_primary$Amount),0)

rh_clim = flows_net_mmt %>% filter(ScenarioName=="Clim", FlowGroupID=="Emission: Total")
rh_clim_mean = round(mean(rh_clim$Amount),0)

rh_lulc = flows_net_mmt %>% filter(ScenarioName=="LULC", FlowGroupID=="Emission: Total")
rh_lulc_mean = round(mean(rh_lulc$Amount),0)

nep_primary = flows_net_mmt %>% filter(ScenarioName=="LULC+Clim", FlowGroupID=="Net Ecosystem Productivity")
nep_primary_mean = round(mean(nep_primary$Amount),0)

lulc_losses = nep_primary_mean-nbp_primary_mean

flow_types_lulc = c("LULC: Emission [Type]", "LULC: Harvest [Type]", "LULC: Mortality [Type]")
flows_lulc = read_csv("data/results/flows_conus.csv") %>%
  left_join(scenario_ids) %>%
  filter(FlowGroupID %in% flow_types_lulc, ScenarioName=="LULC+Clim") %>%
  mutate(Amount=Amount/1000000)

flows_harvest_prim = flows_lulc %>% filter(FlowGroupID=="LULC: Harvest [Type]")
flows_harvest_prim_mean = round(mean(flows_harvest_prim$Amount),0)

flows_emis_prim = flows_lulc %>% filter(FlowGroupID=="LULC: Emission [Type]")
flows_emis_prim_mean = round(mean(flows_emis_prim$Amount),0)

flows_mort_prim = flows_lulc %>% filter(FlowGroupID=="LULC: Mortality [Type]")
flows_mort_prim_mean = round(mean(flows_mort_prim$Amount),0)

# ggplot(flows_lulc, aes(x=Timestep, y=Amount, color=FlowGroupID)) +
#   geom_line() +
#   geom_point() +
#   theme_custom()


```

## Net carbon flux

We estimate that for the period 2001-2020, U.S. forests were on average, a net sink of carbon at a rate of `r nbp_primary_mean` MMT C yr^-1^. Figure \@ref(fig:flowresults) shows the estimated net primary productivity (NPP), heterotrophic respiration (Rh), net ecosystem productivity (NEP) and net biome productivity (NBP) over time for each of the four simulations. The size of the net sink varied considerably from year-to-year, ranging from `r nbp_primary_min` (source) to `r nbp_primary_max` MMT C yr^-1^. Climate variability was the primary driver of inter-annual variability in the size of the forest sink. When climate was not included in the simulations, the size of the net sink ranged from `r nbp_lulc_min` to `r nbp_lulc_max` MMT C yr^-1^ and showed a declining trend over time due to the lack of increased productivity from recent climate conditions. Land use, land-use change, and disturbances were the primary controlling processes effecting the magnitude of the net carbon sink. When LULC was excluded, the forest carbon sink was `r round((nbp_primary_mean/nbp_climate_mean)*100,0)`% higher (mean of `r nbp_climate_mean` MMT C yr^-1^) than simulations where LULC was incorporated.

Net primary productivity (NPP) of U.S. forests averaged `r npp_primary_mean` MMT C yr^-1^. Incorporating the effects of LULC and disturbances reduced total NPP by `r npp_lulc_abs` MMT C yr^-1^ while incorporating the effects of climate variability and change resulted in an increase in NPP of `r abs(npp_clim_abs)` MMT C yr^-1^ compared to the LULC only simulation. These results suggest that LULC and disturbance have a negative impact on NPP while climate variability and change between 2001-2020 have resulted in increased productivity of U.S. forests. Heterotrophic respiration (Rh) increased under all simulations resulting from increases in productivity and climate warming.

Carbon losses from LULC and disturbances reduced the annual forest carbon sink by `r lulc_losses` MMT C yr^-1^ on average. The cumulative loss of carbon sequestration was primarily from the transfer of carbon to harvest wood products which averaged `r flows_harvest_prim_mean` MMT C yr^-1^ while carbon losses from combusion - primarily due to wildfire - averaged `r flows_emis_prim_mean` MMT C yr^-1^. In addition to ecosystem carbon removals, LULC and disturbances resulted in the transfer of an additional `r flows_mort_prim_mean` MMT C yr^-1^ from live to DOM pools which will contribute to future years reductions in the carbon sink. This future flux could be accelerated by continued increases in the turnover rate of DOM resulting from continued climate warming. 

```{r, flowresults, cache=T, echo=F, warning=F, message=F, fig.width=8, fig.height=3, fig.cap="Net fluxes of carbon in conterminous U.S. forests for the period 2002-2020."}

ggplot(flows_net, aes(x=Timestep, y=Amount/1000000, color=ScenarioName, fill=ScenarioName, shape=ScenarioName)) +
  geom_line() +
  scale_color_brewer(palette="Dark2") +
  geom_point(color="white", size=1.5) +
  scale_fill_brewer(palette="Dark2") +
  scale_shape_manual(values=c("LULC+Clim"=21, "Clim"=22, "LULC"=23, "Ref"=24)) +
  facet_wrap(~FlowGroupID, scales="free_y", ncol=4) +
  theme_custom() +
  labs(x="Year", y=expression(Carbon~flux~(MMT~C~yr^-1)), fill="Scenario", shape="Scenario", color="Scenario") +
  theme(legend.position = "bottom",
        legend.key.width = unit(10, "mm"),
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(-10,-10,0,-10))
```

## Carbon stocks



```{r, stockresults, cache=T, echo=F, warning=F, message=F, fig.width=4, fig.height=2.5, fig.cap="Carbon stocks in conterminous U.S. forests from 2001-2020."}
stockypes_live_dom_tec = c("Total Ecosystem", "Biomass: Total", "DOM: Deadwood")

stocks_ipcc = read_csv("data/results/stocks_conus.csv") %>%
  left_join(scenario_ids) %>%
  filter(StockGroupID %in% stockypes_live_dom_tec)

stocks_litter = c("DOM: Aboveground Very Fast [Type]", "DOM: Aboveground Fast [Type]")
stocks_soil = c("DOM: Aboveground Slow [Type]", "DOM: Belowground Slow [Type]", "DOM: Belowground Very Fast [Type]")

stocks_ipcc_litter = read_csv("data/results/stocks_conus.csv") %>%
  left_join(scenario_ids) %>%
  filter(StockGroupID %in% stocks_litter) %>%
  mutate(StockGroupID="DOM: Litter") %>%
  group_by(ScenarioID, Iteration, Timestep, ScenarioName, StockGroupID) %>%
  summarise(Amount=sum(Amount)) 

stocks_ipcc_soil= read_csv("data/results/stocks_conus.csv") %>%
  left_join(scenario_ids) %>%
  filter(StockGroupID %in% stocks_soil) %>%
  mutate(StockGroupID="DOM: Soil") %>%
  group_by(ScenarioID, Iteration, Timestep, ScenarioName, StockGroupID) %>%
  summarise(Amount=sum(Amount)) 

stocks_ipcc = bind_rows(stocks_ipcc, stocks_ipcc_litter, stocks_ipcc_soil)


ps1 = ggplot(stocks_ipcc, aes(x=Timestep, y=Amount/1000000, color=ScenarioName, fill=ScenarioName, shape=ScenarioName)) +
  geom_line() +
  scale_color_brewer(palette="Dark2") +
  geom_point(color="white", size=1.5) +
  scale_fill_brewer(palette="Dark2") +
  scale_shape_manual(values=c("LULC+Clim"=21, "Clim"=22, "LULC"=23, "Ref"=24)) +
  facet_wrap(~StockGroupID, scales="free_y", ncol=5) +
  theme_custom() +
  labs(x="Year", y=expression(Carbon~storage~(MMT~C)), fill="Scenario", shape="Scenario", color="Scenario") +
    theme(legend.position = "bottom",
        legend.key.width = unit(10, "mm"),
        legend.key.height = unit(3, "mm"),
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(-10,-10,0,-10))
```

```{r, stockchange, cache=T, echo=F, warning=F, message=F, fig.width=8, fig.height=4, fig.cap="Carbon stocks in conterminous U.S. forests from 2001-2020."}
stocks_ipcc_change = stocks_ipcc %>%
  filter(Timestep %in% c(2001,2020)) %>%
  arrange(Timestep) %>%
  group_by(ScenarioID, ScenarioName, Iteration, StockGroupID) %>%
  mutate(Change=Amount-lag(Amount)) %>%
  filter(Timestep==2020) %>% arrange(StockGroupID)

ps2 = ggplot(stocks_ipcc_change, aes(x=ScenarioName, y=Change/1000000, fill=ScenarioName)) +
  geom_bar(stat="identity") +
  scale_fill_brewer(palette = "Dark2") +
  facet_wrap(~StockGroupID, scales = "free_y", ncol=5) +
  geom_hline(yintercept = 0, size=0.2) +
  theme_custom() +
  labs(x=NULL, y=expression(Net~flux~(MMT~C)), fill="Scenario", shape="Scenario", color="Scenario") +
  theme(legend.position = "bottom",
        legend.key.width = unit(10, "mm"),
        legend.key.height = unit(3, "mm"),
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(-10,-10,0,-10),
        axis.text.x = element_blank())

plot_grid(ps1, ps2, align=c("hv"), nrow=2)
```

```{r, nbpmap, cache=T, echo=F, warning=F, message=F, fig.width=8, fig.cap="Map of the estiamted net biome productivity of conterminous U.S. forests for the period 2001-2020. Negative values indicate a net loss of carbon from ecosystems and positive values indicate a net sink of carbon."}
land_poly = st_read("data/vector/ne_10m_land.shp", quiet=T)
states_poly = st_read("data/vector/states.shp", quiet=T)
nbp_raster = raster("data/results/flows-nbp-2020.tif")
# nbp_raster = aggregate(nbp_raster, fact=4, na.rm=T)
nbp_raster_df = as.data.frame(nbp_raster, xy=T) %>%
  rename("Amount"="flows.nbp.2020") %>%
  filter(!is.na(Amount))
# 
# min(nbp_raster_df$Amount)
# max(nbp_raster_df$Amount)
# quantile(nbp_raster_df$Amount, probs = seq(0, 1, length.out = 9 + 1))

ggplot() +
  geom_sf(data=land_poly, aes(geometry=geometry), fill="white", color=NA) +
  geom_tile(data=nbp_raster_df, aes(x=x, y=y, fill=Amount)) +
  geom_sf(data=states_poly, aes(geometry=geometry), fill=NA, color="grey20", size=0.2) +
  coord_sf(crs = "+proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=23 +lon_0=-96 +x_0=0 +y_0=0 +ellps=GRS80 +units=m +no_defs",
           xlim=c(min(nbp_raster_df$x), max(nbp_raster_df$x)),
           ylim=c(min(nbp_raster_df$y), max(nbp_raster_df$y))) +
  scale_fill_fermenter(palette = "BrBG", type="seq", direction=1, guide="colorsteps", breaks=c(-100,-20,-10,-5,-2,2,5,10,20, 50)) +
  labs(x=NULL, y=NULL, fill=expression(Metric~Tons~C~ha^-1)) +
  theme_bw() +
  theme(text=element_text(family="Roboto Condensed"),
        legend.position = c(0.2,0.1),
        legend.text.align = 0,
        legend.text = element_text(size = 7, hjust = 0, color = "#4e4d47"),
        legend.title = element_text(size = 8),
        plot.margin = unit(c(1,1,1,1), "mm"),
        legend.key.height = unit(2, "mm"),
        legend.key.width = unit(10, "mm"),
        axis.text.x = element_text(size=8),
        axis.text.y = element_text(size=8),
        panel.background = element_rect(fill="grey90")) +
  guides(fill = guide_colorsteps(direction = "horizontal",
                                 title.position = 'top',
                                 title.hjust = 0,
                                 label.hjust = 1,
                                 nrow = 1,
                                 byrow = T,
                                 reverse = F,
                                 label.position = "bottom",
                                 ticks = T,
                                 ticks.colour = "black",
                                 ticks.linewidth = 0.8,
                                 frame.colour = "black"))

```

```{r, tecmap, cache=T, echo=F, warning=F, message=F, fig.width=8, fig.cap="Map of the estiamted net biome productivity of conterminous U.S. forests for the period 2001-2020. Negative values indicate a net loss of carbon from ecosystems and positive values indicate a net sink of carbon."}
land_poly = st_read("data/vector/ne_10m_land.shp", quiet=T)
states_poly = st_read("data/vector/states.shp", quiet=T)
tec_raster = raster("data/results/stocks-tec-2020.tif")
# tec_raster = aggregate(tec_raster, fact=4, na.rm=T)
tec_raster_df = as.data.frame(tec_raster, xy=T) %>%
  rename("Amount"="stocks.tec.2020") %>%
  filter(Amount>0)

# min(tec_raster_df$Amount)
# max(tec_raster_df$Amount)
# quantile(tec_raster_df$Amount, probs = seq(0, 1, length.out = 9 + 1))

ggplot() +
  geom_sf(data=land_poly, aes(geometry=geometry), fill="white", color=NA) +
  geom_tile(data=tec_raster_df, aes(x=x, y=y, fill=Amount)) +
  geom_sf(data=states_poly, aes(geometry=geometry), fill=NA, color="grey20", size=0.2) +
  coord_sf(crs = "+proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=23 +lon_0=-96 +x_0=0 +y_0=0 +ellps=GRS80 +units=m +no_defs",
           xlim=c(min(tec_raster_df$x), max(tec_raster_df$x)),
           ylim=c(min(tec_raster_df$y), max(tec_raster_df$y))) +
  scale_fill_fermenter(palette = "YlGnBu", type="seq", direction=1, guide="colorsteps", breaks=c(50,100,130,160,190,250,300,400)) +
  labs(x=NULL, y=NULL, fill=expression(Metric~Tons~C~ha^-1)) +
  theme_bw() +
  theme(text=element_text(family="Roboto Condensed"),
        legend.position = c(0.2,0.1),
        legend.text.align = 0,
        legend.text = element_text(size = 7, hjust = 0, color = "#4e4d47"),
        legend.title = element_text(size = 8),
        plot.margin = unit(c(1,1,1,1), "mm"),
        legend.key.height = unit(2, "mm"),
        legend.key.width = unit(10, "mm"),
        axis.text.x = element_text(size=8),
        axis.text.y = element_text(size=8),
        panel.background = element_rect(fill="grey90")) +
  guides(fill = guide_colorsteps(direction = "horizontal",
                                 title.position = 'top',
                                 title.hjust = 0,
                                 label.hjust = 1,
                                 nrow = 1,
                                 byrow = T,
                                 reverse = F,
                                 label.position = "bottom",
                                 ticks = T,
                                 ticks.colour = "black",
                                 ticks.linewidth = 0.8,
                                 frame.colour = "black"))

```
