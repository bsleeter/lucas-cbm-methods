# Results

```{r, warning=F, message=F, echo=F}
library(raster)
library(sf)
library(tidyverse)
library(cowplot)
library(dplyr)
library(kableExtra)
library(scales)

theme_custom <- function(...) {
  theme_bw() +
  theme(
    text = element_text(family="Roboto Condensed"),
    axis.text.x = element_text(size=8),
    axis.text.y = element_text(size=8),
    axis.title.x = element_text(size=8),
    axis.title.y = element_text(size=8),
    plot.margin = margin(3,3,1,3, unit="mm"),
    strip.text = element_text(size=8),
    panel.border = element_rect(fill=NA),
    panel.spacing = unit(2, "mm"),
    panel.grid.minor = element_blank(),
    strip.background = element_blank(),
    legend.text = element_text(size=8),
    legend.title = element_text(size=8),
    ...
  )}

crs = "+proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=23 +lon_0=-96 +x_0=0 +y_0=0 +ellps=GRS80 +units=m +no_defs"

scenario_ids = data.frame(ScenarioID=c(128,134,136,138),
                          ScenarioName = c("LULC+Clim", "Clim", "Ref", "LULC"))

options(scipen=999)
knitr::knit_hooks$set(inline = function(x) {
  if(!is.numeric(x)){x}else{prettyNum(round(x,2), big.mark=",")}})
```

```{r, resultdata, echo=F, warning=F, message=F}

flowTypes_net = c("Net Primary Productivity", "Net Ecosystem Productivity", "Net Biome Productivity", "Emission: Total")

flows_net = read_csv("data/results/flows_conus.csv") %>%
  left_join(scenario_ids) %>%
  filter(FlowGroupID %in% flowTypes_net) %>%
  mutate(FlowGroupID = factor(FlowGroupID, levels=c("Net Primary Productivity","Emission: Total","Net Ecosystem Productivity", "Net Biome Productivity")))

flows_net_mmt = flows_net %>% mutate(Amount=round(Amount/1000000,0))

nbp_primary = flows_net_mmt %>% filter(ScenarioName=="LULC+Clim", FlowGroupID=="Net Biome Productivity")
nbp_primary_mean = round(mean(nbp_primary$Amount),0)
nbp_primary_min = min(nbp_primary$Amount)
nbp_primary_max = max(nbp_primary$Amount)

nbp_lulc = flows_net_mmt %>% filter(ScenarioName=="LULC", FlowGroupID=="Net Biome Productivity")
nbp_lulc_mean = round(mean(nbp_lulc$Amount),0)
nbp_lulc_min = min(nbp_lulc$Amount)
nbp_lulc_max = max(nbp_lulc$Amount)

nbp_climate = flows_net_mmt %>% filter(ScenarioName=="Clim", FlowGroupID=="Net Biome Productivity")
nbp_climate_mean = round(mean(nbp_climate$Amount),0)
nbp_climate_min = min(nbp_climate$Amount)
nbp_climate_max = max(nbp_climate$Amount)

npp_primary = flows_net_mmt %>% filter(ScenarioName=="LULC+Clim", FlowGroupID=="Net Primary Productivity")
npp_primary_mean = round(mean(npp_primary$Amount),0)

npp_clim = flows_net_mmt %>% filter(ScenarioName=="Clim", FlowGroupID=="Net Primary Productivity")
npp_clim_mean = round(mean(npp_clim$Amount),0)

npp_lulc = flows_net_mmt %>% filter(ScenarioName=="LULC", FlowGroupID=="Net Primary Productivity")
npp_lulc_mean = round(mean(npp_lulc$Amount),0)

npp_lulc_pct = round((npp_clim_mean-npp_primary_mean)/npp_clim_mean*100,0)
npp_clim_pct = round((npp_lulc_mean-npp_primary_mean)/npp_lulc_mean*100,0)

npp_lulc_abs = round((npp_clim_mean-npp_primary_mean),0)
npp_clim_abs = round((npp_lulc_mean-npp_primary_mean),0)

rh_primary = flows_net_mmt %>% filter(ScenarioName=="LULC+Clim", FlowGroupID=="Emission: Total")
rh_primary_mean = round(mean(rh_primary$Amount),0)

rh_clim = flows_net_mmt %>% filter(ScenarioName=="Clim", FlowGroupID=="Emission: Total")
rh_clim_mean = round(mean(rh_clim$Amount),0)

rh_lulc = flows_net_mmt %>% filter(ScenarioName=="LULC", FlowGroupID=="Emission: Total")
rh_lulc_mean = round(mean(rh_lulc$Amount),0)

nep_primary = flows_net_mmt %>% filter(ScenarioName=="LULC+Clim", FlowGroupID=="Net Ecosystem Productivity")
nep_primary_mean = round(mean(nep_primary$Amount),0)

lulc_losses = nep_primary_mean-nbp_primary_mean

flow_types_lulc = c("LULC: Emission [Type]", "LULC: Harvest [Type]", "LULC: Mortality [Type]")

flows_lulc = read_csv("data/results/flows_conus.csv") %>%
  left_join(scenario_ids) %>%
  filter(FlowGroupID %in% flow_types_lulc, ScenarioName=="LULC+Clim") %>%
  mutate(Amount=Amount/1000000)

flows_harvest_prim = flows_lulc %>% filter(FlowGroupID=="LULC: Harvest [Type]")
flows_harvest_prim_mean = round(mean(flows_harvest_prim$Amount),0)

flows_emis_prim = flows_lulc %>% filter(FlowGroupID=="LULC: Emission [Type]")
flows_emis_prim_mean = round(mean(flows_emis_prim$Amount),0)
flows_emis_prim_2020 = (flows_lulc %>% filter(FlowGroupID=="LULC: Emission [Type]", Timestep==2020))$Amount

flows_mort_prim = flows_lulc %>% filter(FlowGroupID=="LULC: Mortality [Type]")
flows_mort_prim_mean = round(mean(flows_mort_prim$Amount),0)


```

```{r, resultdata2, echo=F, message=F, warning=F}
stockypes_live_dom_tec = c("Total Ecosystem", "Biomass: Total", "DOM: Deadwood")

stocks_ipcc = read_csv("data/results/stocks_conus.csv") %>%
  left_join(scenario_ids) %>%
  filter(StockGroupID %in% stockypes_live_dom_tec)

stocks_litter = c("DOM: Aboveground Very Fast [Type]", "DOM: Aboveground Fast [Type]")
stocks_soil = c("DOM: Aboveground Slow [Type]", "DOM: Belowground Slow [Type]", "DOM: Belowground Very Fast [Type]")

stocks_ipcc_litter = read_csv("data/results/stocks_conus.csv") %>%
  left_join(scenario_ids) %>%
  filter(StockGroupID %in% stocks_litter) %>%
  mutate(StockGroupID="DOM: Litter") %>%
  group_by(ScenarioID, Iteration, Timestep, ScenarioName, StockGroupID) %>%
  summarise(Amount=sum(Amount)) 

stocks_ipcc_soil= read_csv("data/results/stocks_conus.csv") %>%
  left_join(scenario_ids) %>%
  filter(StockGroupID %in% stocks_soil) %>%
  mutate(StockGroupID="DOM: Soil") %>%
  group_by(ScenarioID, Iteration, Timestep, ScenarioName, StockGroupID) %>%
  summarise(Amount=sum(Amount)) 

stocks_ipcc = bind_rows(stocks_ipcc, stocks_ipcc_litter, stocks_ipcc_soil)

stocks_primary = stocks_ipcc %>% filter(ScenarioName == "LULC+Clim") %>% mutate(Amount = Amount/1000000)
stocks_tec_2001 = round((stocks_primary %>% filter(StockGroupID == "Total Ecosystem", Timestep==2001))$Amount,0)
stocks_live_2001 = round((stocks_primary %>% filter(StockGroupID == "Biomass: Total", Timestep==2001))$Amount,0)
stocks_live_2001_pct = round((stocks_live_2001/stocks_tec_2001)*100,0)
stocks_live_2020 = round((stocks_primary %>% filter(StockGroupID == "Biomass: Total", Timestep==2020))$Amount,0)

stocks_dom_2001 = round(sum((stocks_primary %>% filter(StockGroupID %in% c("DOM: Litter", "DOM: Deadwood", "DOM: Soil"), Timestep==2001))$Amount),0)
stocks_dom_2001_pct = round((stocks_dom_2001/stocks_tec_2001)*100,0)
stocks_dom_2020 = round(sum((stocks_primary %>% filter(StockGroupID %in% c("DOM: Litter", "DOM: Deadwood", "DOM: Soil"), Timestep==2020))$Amount),0)

stocks_ipcc_change = stocks_ipcc %>%
  filter(Timestep %in% c(2001,2020)) %>%
  arrange(Timestep) %>%
  group_by(ScenarioID, ScenarioName, Iteration, StockGroupID) %>%
  mutate(Change=Amount-lag(Amount)) %>%
  filter(Timestep==2020) %>% arrange(StockGroupID) %>%
  mutate(Change=Change/1000000)

stocks_live_change_prim = round((stocks_ipcc_change %>% filter(ScenarioName=="LULC+Clim", StockGroupID=="Biomass: Total"))$Change,0)
stocks_live_change_clim = round((stocks_ipcc_change %>% filter(ScenarioName=="Clim", StockGroupID=="Biomass: Total"))$Change,0)
stocks_soil_change_prim = round((stocks_ipcc_change %>% filter(ScenarioName=="LULC+Clim", StockGroupID=="DOM: Soil"))$Change,0)

tec_change_lulc = (stocks_ipcc_change %>% filter(ScenarioName == "LULC", StockGroupID == "Total Ecosystem"))$Change
tec_change_clim = (stocks_ipcc_change %>% filter(ScenarioName == "Clim", StockGroupID == "Total Ecosystem"))$Change
tec_change_lulc_pct = abs(round(((tec_change_lulc - tec_change_clim)/tec_change_clim)*100, 0))

# Data for stock change table
stock_groups = read_csv("data/tables/stock-groups.csv")

stocks_table = read_csv("data/results/stocks_conus.csv") %>% 
  left_join(scenario_ids) %>%
  mutate(Amount=Amount/1000000) %>%
  filter(Timestep %in% c(2001,2020), ScenarioName=="LULC+Clim") %>%
  select(-ScenarioID, -Iteration, -ScenarioName) %>%
  arrange(StockGroupID) %>%
  right_join(stock_groups) %>%
  arrange(StockGroup) %>%
  select(StockGroup, StockGroupID, Timestep, Amount)

stocks_table_sum = stocks_table %>%
  group_by(StockGroup, Timestep) %>% summarise(Amount=sum(Amount)) %>%
  mutate(StockGroupID = "Total")

stocks_table_merge = bind_rows(stocks_table, stocks_table_sum) %>%
  pivot_wider(names_from=Timestep, values_from=Amount) %>%
  mutate(Change=`2020`-`2001`) %>%
  mutate(PctChange = (`2020`-`2001`)/`2001`*100) %>%
  arrange(StockGroup) %>%
  mutate(StockGroup = factor(StockGroup, levels=c("Aboveground live", "Belowground live", "Deadwood", "Litter", "Soil"))) %>%
  select(-StockGroup)

stocks_snagstem_change_prim = round((stocks_table_merge %>% filter(StockGroupID=="DOM: Snag Stem [Type]"))$Change,0)
```

## Carbon stock change

We estimate U.S. forested ecosystems stored `r stocks_tec_2001` MMT C in 2001 with live carbon accounting for `r stocks_live_2001_pct`% (`r stocks_live_2001` MMT C) and DOM pools accounting for `r stocks_dom_2001_pct`% (`r stocks_dom_2001` MMT C). By 2020, the total carbon stored in live carbon pools increased to `r stocks_live_2020` MMT C while DOM pools remained relatively stable (Table \@ref(tab:lulcfluxtable)). However, the net change in DOM masked dynamics within DOM pools. For example, carbon stored in standing dead snags increased by `r stocks_snagstem_change_prim` MMT C while soil pools declined by `r stocks_soil_change_prim` MMT C (Table \@ref(tab:stocktable)). Net losses in biomass carbon were concentrated in three western U.S. ecoregions (Sierra Nevada Mountains, Klamath Mountains, and Cascades) resulting primarily from the cumulative effect of harvest and fire. All other ecoregions were net sinks of biomass carbon (Figure \@ref(fig:stockchangeeco)). The Middle Rockies and Northern Rockies ecoregions were large sinks of biomass carbon resulting primarily from regrowth following high rates of historical disturbance which occurred prior to 2001. Consequently, these regions also experienced significant net declines in litter and deadwood pools as stocks decomposed over time.

```{r, stocktable, echo=F, warning=F, message=F}
kable(stocks_table_merge, col.names = c("Stock", "2001", "2020", "MMT C", "%"),
      digits = 1,
      booktabs = T,
      escape = F,
      caption="Carbon stock estimates for forest ecosystems of the conterminous U.S.. Units are in MMT C.") %>%
  kable_classic(lightable_options = c("striped"), font_size=12, full_width = F) %>%
  add_header_above(c(" ", "Year"=2, "Change"=2)) %>%
  pack_rows(index = c("Aboveground live" = 4, 
                      "Belowground live" = 3, 
                      "Deadwood" = 5,
                      "Litter" = 3,
                      "Soil" = 4)) %>%
  footnote(general = "The Aboveground Slow pool has been included with the IPCC Soil pool rather than the Litter pool as done in the CBM-CFS3 model.")
```

```{r, stockchangeeco, cache=T, echo=F, warning=F, message=F, fig.width=8, fig.height=4, fig.cap="Net change in carbon pools by ecoegion for the period 2001-2020. "}
states_poly = st_read("data/vector/cb_2018_us_state_20m.shp", quiet=T)
eco_poly = st_read("data/vector/us_eco_l3_no_st_simp.shp", quiet=T) %>%
  st_simplify()
eco_code = read_csv("data/tables/ecoregions.csv")

stocks_ecoreg = read_csv("data/results/stocks_ecoregions.csv") %>%
  left_join(scenario_ids) %>% filter(ScenarioName=="LULC+Clim") %>%
  mutate(Amount=Amount/1000000) %>%
  filter(Timestep %in% c(2001,2020)) %>% arrange(Timestep) %>%
  group_by(StratumID, StockGroupID, ScenarioName) %>%
  mutate(Change = Amount-lag(Amount)) %>% filter(Timestep==2020) %>%
  left_join(eco_code, by=c("StratumID"="Name")) %>%
  mutate(ID = as.character(ID)) %>%
  left_join(eco_poly, by=c("ID"="US_L3CODE"))

stocks_ecoreg_groups_bio = stocks_ecoreg %>%
  filter(StockGroupID %in% c("Biomass: Total"))

stocks_ecoreg_groups_dwd = stocks_ecoreg %>%
  filter(StockGroupID %in% c("DOM: Deadwood"))

stocks_ecoreg_groups_lit = stocks_ecoreg %>%
  filter(StockGroupID %in% c("DOM: Litter"))

stocks_ecoreg_groups_soc = stocks_ecoreg %>%
  filter(StockGroupID %in% c("DOM: Soil"))

# Biomass map ----
bio = 
  ggplot() +
  geom_sf(data=stocks_ecoreg_groups_bio, aes(geometry=geometry, fill=Change), color="grey90") +
  geom_sf(data=states_poly, aes(geometry=geometry), fill=NA, color="grey30") +
  scale_fill_gradient2(low=muted("red"), mid="beige", high=muted("green"), midpoint=0, guide="colorsteps", n.breaks=7) +
  coord_sf(crs = "+proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=23 +lon_0=-96 +x_0=0 +y_0=0 +ellps=GRS80 +units=m +no_defs",
           xlim=c(-2200000,2100000), ylim=c(380000,3100000)) +
  labs(fill="MMT C", subtitle="Living biomass") +
  theme_custom(legend.position = "right",
               legend.key.height = unit(5, "mm"),
               legend.key.width = unit(2, "mm"),
               legend.background = element_blank()) +
  guides(fill = guide_colorsteps(direction = "vertical",
                                 title.position = 'top',
                                 label.position = "right",
                                 ticks = T,
                                 ticks.colour = "black",
                                 ticks.linewidth = 0.8,
                                 frame.colour = "black"))

# Deadwood map ----
dwd = 
  ggplot() +
  geom_sf(data=stocks_ecoreg_groups_dwd, aes(geometry=geometry, fill=Change), color="grey90") +
  geom_sf(data=states_poly, aes(geometry=geometry), fill=NA, color="grey30") +
  scale_fill_gradient2(low=muted("red"), mid="beige", high=muted("green"), midpoint=0, guide="colorsteps", n.breaks=7) +
  coord_sf(crs = "+proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=23 +lon_0=-96 +x_0=0 +y_0=0 +ellps=GRS80 +units=m +no_defs",
           xlim=c(-2200000,2100000), ylim=c(380000,3100000)) +
  labs(fill="MMT C", subtitle="DOM: Deadwood") +
  theme_custom(legend.position = "right",
               legend.key.height = unit(5, "mm"),
               legend.key.width = unit(2, "mm"),
               legend.background = element_blank()) +
  guides(fill = guide_colorsteps(direction = "vertical",
                                 title.position = 'top',
                                 label.position = "right",
                                 ticks = T,
                                 ticks.colour = "black",
                                 ticks.linewidth = 0.8,
                                 frame.colour = "black"))
# Litter map ----
lit = 
  ggplot() +
  geom_sf(data=stocks_ecoreg_groups_lit, aes(geometry=geometry, fill=Change), color="grey90") +
  geom_sf(data=states_poly, aes(geometry=geometry), fill=NA, color="grey30") +
  scale_fill_gradient2(low=muted("red"), mid="beige", high=muted("green"), midpoint=0, guide="colorsteps", n.breaks=7) +
  coord_sf(crs = "+proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=23 +lon_0=-96 +x_0=0 +y_0=0 +ellps=GRS80 +units=m +no_defs",
           xlim=c(-2200000,2100000), ylim=c(380000,3100000)) +
  labs(fill="MMT C", subtitle="DOM: Litter") +
  theme_custom(legend.position = "right",
               legend.key.height = unit(5, "mm"),
               legend.key.width = unit(2, "mm"),
               legend.background = element_blank()) +
  guides(fill = guide_colorsteps(direction = "vertical",
                                 title.position = 'top',
                                 label.position = "right",
                                 ticks = T,
                                 ticks.colour = "black",
                                 ticks.linewidth = 0.8,
                                 frame.colour = "black"))
# Soil map ----
soc = 
  ggplot() +
  geom_sf(data=stocks_ecoreg_groups_soc, aes(geometry=geometry, fill=Change), color="grey90") +
  geom_sf(data=states_poly, aes(geometry=geometry), fill=NA, color="grey30") +
  scale_fill_gradient2(low=muted("red"), mid="beige", high=muted("green"), midpoint=0, guide="colorsteps", n.breaks=7) +
  coord_sf(crs = "+proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=23 +lon_0=-96 +x_0=0 +y_0=0 +ellps=GRS80 +units=m +no_defs",
           xlim=c(-2200000,2100000), ylim=c(380000,3100000)) +
  labs(fill="MMT C", subtitle="DOM: Soil") +
  theme_custom(legend.position = "right",
               legend.key.height = unit(5, "mm"),
               legend.key.width = unit(2, "mm"),
               legend.background = element_blank()) +
  guides(fill = guide_colorsteps(direction = "vertical",
                                 title.position = 'top',
                                 label.position = "right",
                                 ticks = T,
                                 ticks.colour = "black",
                                 ticks.linewidth = 0.8,
                                 frame.colour = "black"))
# Cowplot ----
plot_grid(bio, dwd, lit, soc, ncol=2, align="hv", labels="auto", label_size = 10, label_fontface = "plain")
```

Changes in LULC were an important driver of carbon stock change. When the effects of LULC were included in simulations, increases in live carbon were modest (`r stocks_live_change_prim` MMT C) relative to simulations without LULC and disturbances (`r stocks_live_change_clim` MMT C). Furthermore, changes in LULC and disturbance resulted in increases in litter and deadwood relative to simulations without LULC. Wildfire and forest harvest transitions result in large fluxes of carbon from live to DOM pools, either the result of root and branch biomass left on-site after harvest or through mortality of live vegetation. The subsequent increases in DOM pools post-disturbance provide large quantities of carbon as inputs to the soil pool over time. Given the reduction of SOC input, excluding LULC/disturbance pathways from the model results in large declines in SOC relative to scenarios where LULC/disturbance are considered. In total, the inclusion of LULC/disturbances in simulations reduced the total size of the net carbon sink in the conterminous US by `r tec_change_lulc_pct`%>% compared to simulations where only the effects of climate were considered. Results show that while climate was the primary driver of inter-annual variability in the annual net flux of carbon \@ref(fig:flowresults), LULC and disturbance were the primary controlling processes governing the magnitude of ecosystem carbon storage and flux in the United States.

```{r, stockchange, cache=T, echo=F, warning=F, message=F, fig.width=8, fig.height=2, fig.cap="Net change in carbon stocks between 2001-2020. The 'Clim' scenario includes only the effects from climate variability and change; 'LULC' assumes only effects from land use and disturbances; 'LULC+Clim' includes both LULC and climate effects, and 'Ref' assumes no effects from either LULC or climate."}

ggplot(stocks_ipcc_change, aes(x=ScenarioName, y=Change, fill=ScenarioName)) +
  geom_hline(yintercept = 0, size=0.2) +
  geom_bar(stat="identity", color="black") +
  scale_y_continuous(label = comma) +
  scale_fill_brewer(palette = "Accent") +
  facet_wrap(~StockGroupID, scales = "free_y", ncol=5) +
  theme_custom() +
  labs(x=NULL, y=expression(Net~flux~(MMT~C)), fill="Scenario", shape="Scenario", color="Scenario") +
  theme(legend.position = "right",
        legend.key.width = unit(5, "mm"),
        legend.key.height = unit(3, "mm"),
        axis.text.x = element_blank())


```

## Net carbon flux

For the period 2001-2020, U.S. forests were on average, a net sink of carbon at a rate of `r nbp_primary_mean` MMT C yr^-1^. Figure \@ref(fig:flowresults) shows the estimated net primary productivity (NPP), heterotrophic respiration (Rh), net ecosystem productivity (NEP) and net biome productivity (NBP) over time for each of the four simulations. The size of the net sink varied considerably from year-to-year, ranging from `r nbp_primary_min` MMT C yr^-1^ (source) to `r nbp_primary_max` MMT C yr^-1^ (sink). Climate was the primary driver of inter-annual variability in the size of the forest sink. When climate was not included in simulations, the size of the net sink ranged from `r nbp_lulc_min` to `r nbp_lulc_max` MMT C yr^-1^ and showed a declining trend over time due to the absence of increased productivity from recent climate conditions. Land use, land-use change, and disturbances were the primary controlling processes effecting the magnitude of the net carbon sink. When LULC was excluded, the forest carbon sink was `r round((nbp_primary_mean/nbp_climate_mean)*100,0)`% higher (mean of `r nbp_climate_mean` MMT C yr^-1^) than simulations where LULC was included.

Net primary productivity (NPP) of U.S. forests averaged `r npp_primary_mean` MMT C yr^-1^. Incorporating the effects of LULC and disturbances reduced total NPP by `r npp_lulc_abs` MMT C yr^-1^ while incorporating the effects of climate resulted in an increase in NPP of `r abs(npp_clim_abs)` MMT C yr^-1^ compared to the LULC only simulation. These results suggest that LULC and disturbance have a negative impact on NPP while climate variability and change between 2001-2020 have resulted in increased productivity of U.S. forests. Heterotrophic respiration (Rh) increased under all simulations resulting from increases in productivity and climate warming.

```{r, flowresults, cache=T, echo=F, warning=F, message=F, fig.width=8, fig.height=3, fig.cap="Net fluxes of carbon in conterminous U.S. forests for the period 2002-2020."}

ggplot(flows_net, aes(x=Timestep, y=Amount/1000000, color=ScenarioName, fill=ScenarioName, shape=ScenarioName)) +
  geom_line() +
  scale_color_brewer(palette="Dark2") +
  geom_point(color="white", size=1.5) +
  scale_fill_brewer(palette="Dark2") +
  scale_shape_manual(values=c("LULC+Clim"=21, "Clim"=22, "LULC"=23, "Ref"=24)) +
  facet_wrap(~FlowGroupID, scales="free_y", ncol=4) +
  theme_custom() +
  labs(x="Year", y=expression(Carbon~flux~(MMT~C~yr^-1)), fill="Scenario", shape="Scenario", color="Scenario") +
  theme(legend.position = "bottom",
        legend.key.width = unit(10, "mm"),
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(-10,-10,0,-10))
```

## Effects of LULC and disturbance

```{r, lulcfluxdata, echo=F, warning=F, message=F}

trans_types_by_group = read_csv("data/tables/transition-types-by-group.csv")

lulc_removals = read_csv("data/results/flows_transitions.csv") %>% 
  left_join(scenario_ids) %>%
  filter(ScenarioName=="LULC+Clim", !FlowGroupID %in% c("Net Biome Productivity")) %>%
  group_by(ScenarioName, FlowGroupID, TransitionTypeID) %>%
  summarise(Amount=mean(Amount)/1000000) %>%
  left_join(trans_types_by_group) %>%
  ungroup() %>%
  select(TransitionGroupID, TransitionTypeID, FlowGroupID, Amount) 

lulc_removals_sum = lulc_removals %>%
  group_by(TransitionGroupID, FlowGroupID) %>%
  summarise(Amount=sum(Amount)) %>%
  mutate(TransitionTypeID = "Total")

lulc_removals = bind_rows(lulc_removals, lulc_removals_sum) %>%
  pivot_wider(names_from = FlowGroupID, values_from = Amount) %>%
  mutate(TransitionGroupID = factor(TransitionGroupID, levels = c("Ag Expansion", "Urbanization", "Forest Harvest", "Fire", "Insect"))) %>%
  mutate(TransitionTypeID = factor(TransitionTypeID, 
                                   levels=c("Ag Expansion: Cropland","Ag Expansion: Pasture",
                                                              "Urbanization: High","Urbanization: Medium","Urbanization: Low","Urbanization: Open",
                                                              "Forest Harvest: Forest Clearcut","Forest Harvest: Forest Selection",
                                                              "Fire: High Severity","Fire: Medium Severity","Fire: Low Severity",
                                                              "Insect: High Severity","Insect: Medium Severity","Insect: Low Severity",
                                                              "Total"))) %>%
  arrange(TransitionGroupID, TransitionTypeID) 

fire_emissions = (lulc_removals %>% filter(TransitionGroupID=="Fire", TransitionTypeID=="Total"))$`LULC: Emission [Type]`
urban_emissions = (lulc_removals %>% filter(TransitionGroupID=="Urbanization", TransitionTypeID=="Total"))$`LULC: Emission [Type]`
ag_emissions = (lulc_removals %>% filter(TransitionGroupID=="Ag Expansion", TransitionTypeID=="Total"))$`LULC: Emission [Type]`
total_emissions = sum((lulc_removals %>% filter(TransitionTypeID=="Total"))$`LULC: Emission [Type]`, na.rm=T)
fire_emissions_pct = round((fire_emissions/total_emissions)*100,0)
urban_emissions_pct = round((urban_emissions/total_emissions)*100,0)
ag_emissions_pct = round((ag_emissions/total_emissions)*100,0)

transition_area = read_csv("data/results/transitions_conus.csv") %>%
  left_join(scenario_ids)
fire_area = transition_area %>% filter(TransitionGroupID == "Fire", ScenarioName == "LULC+Clim")
fire_area_mean = mean(fire_area$Amount)
fire_area_2020 = round((fire_area %>% filter(Timestep==2020))$Amount/1000000,1)
fire_area_2020_pct = round(fire_area_2020/fire_area_mean *100,0)
```

Table \@ref(tab:lulcfluxtable) shows the emission, harvest, and mortality fluxes for the LULC and disturbances transitions considered in this study. Carbon losses from LULC and disturbances reduced the annual forest carbon sink by `r lulc_losses` MMT C yr^-1^ on average. The cumulative loss of carbon sequestration was primarily from the transfer of carbon to harvested wood products (`r flows_harvest_prim_mean` MMT C yr^-1^) with clearcut harvest accounting for more than 90% of the carbon removal from ecosystems. Harvest activities also resulted in a similar amount of carbon transferred from live to DOM pools. 

Ecosystem carbon losses from combustion averaged `r flows_emis_prim_mean` MMT C yr^-1^, with wildfire accounting for `r fire_emissions_pct`% of all LULC and disturbance related emissions; emissions from urbanization and agricultural expansion accounted for `r urban_emissions_pct`% and `r ag_emissions_pct`%, respectfully. Emissions from wildfire were highly variable from year-to-year. However, the three highest fire emission years all occurred since 2017. In 2020, wildfire burned ~`r fire_area_2020` million hectares, primarily in California and Oregon, an amount `r fire_area_2020_pct`% greater than the historical average. Emissions were estimated to be `r flows_emis_prim_2020` MMT C (`r flows_emis_prim_2020*3.67` MMT CO~2~), which were more then three times the historical average. 

In addition to ecosystem carbon removals, LULC and disturbances resulted in the transfer of an additional `r flows_mort_prim_mean` MMT C yr^-1^ from live to DOM pools which will contribute to future years reductions in the carbon sink through their decay and decomposition. This future flux could be accelerated by continued increases in the turnover rate of DOM resulting from climate warming.



```{r, lulcfluxtable, echo=F, warning=F, message=F}
options(knitr.kable.NA = "---")

kable(lulc_removals, col.names = c("TransitionGroupID", "Transition Type", "Emission", "Harvest", "Mortality", "Transfer"),
      digits = 2,
      booktabs = T,
      escape = F,
      caption="Average annual Fluxes of carbon resulting from land use, land-use change, and disturbances for the period 2001-2020. Emissions refer to the direct combustion of carbon to the atmosphere as either carbon monoxide, methane, or carbon dioxide. All emissions are shown in units of carbon. Harvest refers to the transfer of carbon out of the ecosystem to harvested wood products. Mortality is the transfer of live carbon to DOM pools. Transfer refers to the transfer of carbon from one DOM pool to another. Units are in MMT C yr.") %>%
  kable_paper(font_size=12, full_width = F) %>%
  collapse_rows(1:2, valign="top")

```


## Projections of carbon change

For the western U.S., we projected future carbon storage and flux between 2020 and 2050 under for two climate models under the RCP 4.5 radiative forcing scenario. We used the CanESM2 and HADGEM2-ES365 downscaled climate futures for RCP 4.5 to project changes in carbon storage and flux for U.S. forested ecosystems. Climate data from the Coupled Model Inter-comparison Project (CMIP5) were downscaled using the Multivariate Adaptive Constructed Analogs (MACA) (@abatzoglou2012comparison). Downscaled climate data were used to produce annual spatial flow multipliers used to scale vegetation growth and the decay and decomposition of DOM at the pixel level. MACA data were downscaled from their native \~4km resolution to 1km using a bilinear method. Future LULC and disturbances were sampled, with replacement, from historical rates of change following methods described in @sleeter2019effects. Additional details are described in the methods section.

Total ecosystem carbon storage was projected to continue to increase under both climate model simulations, with larger gains realized under the CanESM2 model as opposed to HadGEM2-ES365. However, the projected net carbon sink rate under both models was projected to be lower than that of the historical period. The

```{r, fluxprojection, echo=F, warning=F, message=F, fig.width=8, fig.height=4}
scenario_ids_proj = data.frame(ScenarioID = c(74,94,95),
                               ScenarioName = c("Historical", "CanESM2", "HadGEM2-ES365"))
flux_proj = read_csv("data/results/flows_west.csv") %>%
  left_join(scenario_ids_proj) %>%
  filter(FlowGroupID %in% c("Net Biome Productivity", "Net Ecosystem Productivity", "Net Primary Productivity")) %>%
  group_by(ScenarioName, FlowGroupID)

flux_proj_mean = flux_proj %>% group_by(FlowGroupID, ScenarioName) %>% summarise(Mean = mean(Amount))
npp_canesm_proj = round((flux_proj_mean %>% filter(FlowGroupID=="Net Primary Productivity", ScenarioName=="CanESM2"))$Mean/1000000,1)

ggplot(flux_proj, aes(x=Timestep, y=Amount, color=ScenarioName)) +
  geom_line() +
  facet_wrap(~FlowGroupID, scales="free_y")

ggplot(flux_proj, aes(x=ScenarioName, y=Amount/1000000, color=ScenarioName)) +
  geom_boxplot() +
  facet_wrap(~FlowGroupID, scales="free_x") +
  coord_flip() +
  theme_bw(10)

stock_proj = read_csv("data/results/stocks_west.csv") %>%
  left_join(scenario_ids_proj) %>%
  filter(StockGroupID %in% c("Biomass: Total", "DOM: Total", "Total Ecosystem")) %>%
  mutate(StockGroupID = factor(StockGroupID, levels=c("Biomass: Total", "DOM: Total", "Total Ecosystem")))

ggplot(stock_proj, aes(x=Timestep, y=Amount/1000000, color=ScenarioName)) +
  geom_line() +
  #geom_point() +
  scale_color_manual(values=c("Historical"="black", "CanESM2"="forestgreen", "HadGEM2-ES365"="red3")) +
  facet_wrap(~StockGroupID, scales="free_y", ncol=3) +
  theme_bw(10) +
  labs(x="Year", y="MMT C", color="Scenario") +
  theme(legend.position = "right")


```
